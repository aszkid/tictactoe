<html>
<head>
<title>minimal demo</title>

<!-- CSS goes here -->
<style>
body {
	background-color: #FFF; /* example... */
}
</style>

<!-- import convnetjs library -->
<script src="convnet-min.js"></script>

<!-- javascript goes here -->
<script type="text/javascript">

function periodic() {
	//d.innerHTML = 'Random number: ' + Math.random()
}

function transform(frome, transf) {
	var to = new Array(transf.length);
	for(var j = 0; j < transf.length; j++) {
		to[j] = frome[transf[j]];
	}
	return to;
}
function transform_o(frome, transf) {
	return transf.map(function(x){return x;}).indexOf(frome);
}

var net; // declared outside -> global variable in window scope
function start() {
	var layers = [];
	layers.push({type:'input', out_sx:1, out_sy:1, out_depth:9});
	layers.push({type:'fc', num_neurons:27, activation:'tanh'});
	layers.push({type:'fc', num_neurons:27, activation:'tanh'});
	layers.push({type:'fc', num_neurons:27, activation:'tanh'});
	layers.push({type:'softmax', num_classes:9});
	net = new convnetjs.Net();
	net.makeLayers(layers);

	var situation = [
		0,0,0,
		0,1,0,
		0,0,0
	];
	var situation_o = situation;
	var x = new convnetjs.Vol(situation);

	var database = [
		[[0,1,0,0,0,0,0,0,0],0],
		[[0,0,0,0,1,0,0,0,0],6],
		[[1,0,0,0,0,0,0,0,0],4],
		[[0,0,0,0,0,0,-1,1,1],3],
		[[0,1,0,0,-1,0,0,0,1],0],
		[[0,1,-1,0,0,1,0,0,0],7],
		[[1,0,0,0,1,0,0,0,-1],6],
		[[0,0,-1,0,0,1,1,0,0],4],
		[[0,0,1,0,0,0,0,1,-1],4],
		[[-1,0,0,1,0,0,0,1,0],2],
		[[0,0,1,0,-1,0,1,0,0],5],
		[[1,0,0,-1,1,1,0,0,-1],6],
		[[1,-1,1,0,-1,0,0,1,0],8],
		[[0,0,0,1,0,-1,-1,1,1],1],
		[[1,-1,0,0,0,1,0,1,-1],3],
		[[0,1,-1,0,-1,1,1,0,0],8],
		[[0,0,1,-1,0,1,0,1,-1],0],
		//[[0,0,0,0,0,0,0,0,0],4],

		/*[[3,3],0],
		[[1,2],0],
		[[8,5],0],
		[[3,4],0],
		[[9,1],0],
		[[-1,2],1],
		[[-5,6],1],
		[[-3,1],1],
		[[-6,8],1],
		[[-5,4],1],
		[[-1,-8],2],
		[[-5,-6],2],
		[[3,-5],2],
		[[6,-6],2],
		[[0,-4],2]*/
	];
	var transf_0 = [6,3,0,7,4,1,8,5,2];
	var transf_1 = [2,1,0,5,4,3,8,7,6];
	var transf_2 = [6,7,8,3,4,5,0,1,2];
	var transf_3 = [8,5,2,7,4,1,6,3,0];
	var transf_4 = [0,3,6,1,4,7,2,5,8];

	var layer = new Array(situation.length);
	var out = null;
	var trainer = new convnetjs.Trainer(net, {learning_rate:0.01, l2_decay:0.001});
	for(var i = 0; i < database.length; i++) {
		var entry = null;
		layer = database[i][0];
		out = database[i][1];

		// vanilla layout, e rotation
		entry = new convnetjs.Vol(layer);
		trainer.train(entry, out);

		// rotation 90 deg
		for(var j = 0; j < 3; j++) {
			layer = transform(layer, transf_0);
			out = transform_o(out, transf_0);
			entry = new convnetjs.Vol(layer);
			trainer.train(entry, out);
		}
		// go back to e
		layer = transform(layer, transf_0);
		out = transform_o(out, transf_0);

		// transform 1
		layer = transform(layer, transf_1);
		out = transform_o(out, transf_1);
		entry = new convnetjs.Vol(layer);
		trainer.train(entry, out);
		layer = transform(layer, transf_1);
		out = transform_o(out, transf_1);

		// transform 2
		layer = transform(layer, transf_2);
		out = transform_o(out, transf_2);
		entry = new convnetjs.Vol(layer);
		trainer.train(entry, out);
		layer = transform(layer, transf_2);
		out = transform_o(out, transf_2);

		// transform 3
		layer = transform(layer, transf_3);
		out = transform_o(out, transf_3);
		entry = new convnetjs.Vol(layer);
		trainer.train(entry, out);
		layer = transform(layer, transf_3);
		out = transform_o(out, transf_3);

		// transform 4
		layer = transform(layer, transf_4);
		out = transform_o(out, transf_4);
		entry = new convnetjs.Vol(layer);
		trainer.train(entry, out);
		layer = transform(layer, transf_4);
		out = transform_o(out, transf_4);
	}

	// check if we have to block or can win
	var lines = [
		[0,1,2],
		[3,4,5],
		[6,7,8],
		[0,3,6],
		[1,4,7],
		[2,5,8],
		[0,4,8],
		[2,4,6]
	];
	var sum = 0;
	var empty = null;
	var canwin = false;
	var wemoveto = null;

	for(var i = 0; i < lines.length; i++) {
		for(var j = 0; j < lines[i].length; j++) {
			var what = situation[lines[i][j]];
			sum += what;
			if(what == 0) {
				empty = lines[i][j];
			}
		}
		if(sum==-2) {
			canwin = true;
			wemoveto = empty;
			break;
		}
		sum = 0;
	}

	if(!canwin) {
		for(var i = 0; i < lines.length; i++) {
			for(var j = 0; j < lines[i].length; j++) {
				var what = situation[lines[i][j]];
				sum += what;
				if(what == 0) {
					empty = lines[i][j];
				}
			}
			if(sum==2) {
				break;
			}
			sum = 0;
		}

		if(sum==2) {
			// enemy is about to win: block!!
			console.log("move to " + empty);
			wemoveto = empty;
		} else {
			var prob = net.forward(x);
			for(var i = 0; i < prob.w.length; i++) {
				document.querySelectorAll("#original .tab-" + i.toString())[0].innerHTML = situation[i];
				document.querySelectorAll("#probtab .tab-" + i.toString())[0].innerHTML = prob.w[i].toFixed(3);
				document.querySelectorAll("#movement .tab-" + i.toString())[0].innerHTML = situation_o[i];
			}
			while(true) {
				//var temp = prob.w.indexOf(Math.max.apply(Math, prob.w));
				var maxx = prob.w[0];
				var temp = 0;
				for(var i = 1; i < prob.w.length; i++) {
					if(prob.w[i] > maxx) {
						temp = i;
						maxx = prob.w[i];
					}
				}

				if(situation_o[temp] !== 0) {
					prob.w[temp] = 0;
					continue;
				}
				wemoveto = temp;
				console.log(wemoveto + " (" + wemoveto%3 + "," + Math.floor(wemoveto/3) + ")");
				break;
			}
		}
	}

	for(var i = 0; i < situation.length; i++) {
		document.querySelectorAll("#original .tab-" + i.toString())[0].innerHTML = situation[i];
		document.querySelectorAll("#movement .tab-" + i.toString())[0].innerHTML = situation_o[i];
	}

	document.querySelectorAll("#movement .tab-" + wemoveto)[0].innerHTML = -1;
}

</script>
</head>

<body onload="start()">
<p id="egdiv"></p>
<h2>Original position</h2>
<table id="original" border="1">
	<tr>
		<td class="tab-0"></td>
		<td class="tab-1"></td>
		<td class="tab-2"></td>
	</tr>
	<tr>
		<td class="tab-3"></td>
		<td class="tab-4"></td>
		<td class="tab-5"></td>
	</tr>
	<tr>
		<td class="tab-6"></td>
		<td class="tab-7"></td>
		<td class="tab-8"></td>
	</tr>
</table>

<h2>Probability table</h2>
<table id="probtab" border="1">
	<tr>
		<td class="tab-0"></td>
		<td class="tab-1"></td>
		<td class="tab-2"></td>
	</tr>
	<tr>
		<td class="tab-3"></td>
		<td class="tab-4"></td>
		<td class="tab-5"></td>
	</tr>
	<tr>
		<td class="tab-6"></td>
		<td class="tab-7"></td>
		<td class="tab-8"></td>
	</tr>
</table>

<h2>Final move</h2>
<table id="movement" border="1">
	<tr>
		<td class="tab-0"></td>
		<td class="tab-1"></td>
		<td class="tab-2"></td>
	</tr>
	<tr>
		<td class="tab-3"></td>
		<td class="tab-4"></td>
		<td class="tab-5"></td>
	</tr>
	<tr>
		<td class="tab-6"></td>
		<td class="tab-7"></td>
		<td class="tab-8"></td>
	</tr>
</table>
</body>
</html>
